{
  "hash": "bd914ea836005f47afae32a9702f4442",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Preprocessing fossil data\"\nauthor: 'Gabriel Munoz'\ndate: today\nfreeze: true\nexecute: \n  warning: false\n  message: true\n---\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| eval: true\n#| echo: false\n#| message: true\n#| warning: false\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'dplyr'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| eval: true\n#| echo: false\n#| message: true\n#| warning: false\nlibrary(ggplot2)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: package 'ggplot2' was built under R version 4.3.3\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| eval: true\n#| echo: false\n#| message: true\n#| warning: false\nlibrary(sf)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: package 'sf' was built under R version 4.3.2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLinking to GEOS 3.11.2, GDAL 3.7.2, PROJ 9.3.0; sf_use_s2() is TRUE\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| eval: true\n#| echo: false\n#| message: true\n#| warning: false\nlibrary('palaeoverse')\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: package 'palaeoverse' was built under R version 4.3.3\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe legacy packages maptools, rgdal, and rgeos, underpinning the sp package,\nwhich was just loaded, will retire in October 2023.\nPlease refer to R-spatial evolution reports for details, especially\nhttps://r-spatial.org/r/2023/05/15/evolution4.html.\nIt may be desirable to make the sf package available;\npackage maintainers should consider adding sf to Suggests:.\nThe sp package is now running under evolution status 2\n     (status 2 uses the sf package in place of rgdal)\n```\n\n\n:::\n:::\n\n\n## Fossil data\n\nWe will use a cut of the NOW database, kindly provided by `Shan`\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nfossil <- read.csv(\"DATA/NOW_filtered_by_Shan_Oct2019.csv\")\n\n# subset only the data we need \n\nfossil <- fossil |> \n  select(LIDNUM, GENUS, SPECIES, FAMILY, ORDER, MIN_AGE, MAX_AGE, LONG, LAT)\n```\n:::\n\n\nLet's examine a summary of the dataset\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ngtsummary::tbl_summary(fossil, \n                       include = c('ORDER', 'MAX_AGE', 'MIN_AGE'))\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"gxofqydqxj\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#gxofqydqxj table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#gxofqydqxj thead, #gxofqydqxj tbody, #gxofqydqxj tfoot, #gxofqydqxj tr, #gxofqydqxj td, #gxofqydqxj th {\n  border-style: none;\n}\n\n#gxofqydqxj p {\n  margin: 0;\n  padding: 0;\n}\n\n#gxofqydqxj .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#gxofqydqxj .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#gxofqydqxj .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#gxofqydqxj .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#gxofqydqxj .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#gxofqydqxj .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#gxofqydqxj .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#gxofqydqxj .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#gxofqydqxj .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#gxofqydqxj .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#gxofqydqxj .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#gxofqydqxj .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#gxofqydqxj .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#gxofqydqxj .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#gxofqydqxj .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#gxofqydqxj .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#gxofqydqxj .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#gxofqydqxj .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#gxofqydqxj .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#gxofqydqxj .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#gxofqydqxj .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#gxofqydqxj .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#gxofqydqxj .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#gxofqydqxj .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#gxofqydqxj .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#gxofqydqxj .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#gxofqydqxj .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#gxofqydqxj .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#gxofqydqxj .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#gxofqydqxj .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#gxofqydqxj .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#gxofqydqxj .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#gxofqydqxj .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#gxofqydqxj .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#gxofqydqxj .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#gxofqydqxj .gt_left {\n  text-align: left;\n}\n\n#gxofqydqxj .gt_center {\n  text-align: center;\n}\n\n#gxofqydqxj .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#gxofqydqxj .gt_font_normal {\n  font-weight: normal;\n}\n\n#gxofqydqxj .gt_font_bold {\n  font-weight: bold;\n}\n\n#gxofqydqxj .gt_font_italic {\n  font-style: italic;\n}\n\n#gxofqydqxj .gt_super {\n  font-size: 65%;\n}\n\n#gxofqydqxj .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#gxofqydqxj .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#gxofqydqxj .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#gxofqydqxj .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#gxofqydqxj .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#gxofqydqxj .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#gxofqydqxj .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;Characteristic&lt;/strong&gt;\"><strong>Characteristic</strong></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;N = 18,349&lt;/strong&gt;&lt;span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/span&gt;\"><strong>N = 18,349</strong><span class=\"gt_footnote_marks\" style=\"white-space:nowrap;font-style:italic;font-weight:normal;\"><sup>1</sup></span></th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">ORDER</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\"><br /></td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    Artiodactyla</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">7,406 (40%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    Carnivora</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">4,742 (26%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    Perissodactyla</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">4,355 (24%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    Primates</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">273 (1.5%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    Proboscidea</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">1,573 (8.6%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">MAX_AGE</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">11.2 (7.1, 16.0)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">MIN_AGE</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">9.0 (5.3, 14.2)</td></tr>\n  </tbody>\n  \n  <tfoot class=\"gt_footnotes\">\n    <tr>\n      <td class=\"gt_footnote\" colspan=\"2\"><span class=\"gt_footnote_marks\" style=\"white-space:nowrap;font-style:italic;font-weight:normal;\"><sup>1</sup></span> n (%); Median (Q1, Q3)</td>\n    </tr>\n  </tfoot>\n</table>\n</div>\n```\n\n:::\n:::\n\n\n### Spatio-temporal data coverage\n\nLet's examine the spatiotemporal extent of the dataset, and filter according to our needs.\n\nFirst, lets create two new columns, `time_period_min` and `time_period_max` to assign categorical time periods based on the estimated radiocarbon data.\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n## define a function to assign time periods based on literature thresholds \n\nchange_time_to_period <- function(MIN_AGE){\n  case_when(round(MIN_AGE) %in% c(21:23) ~ 'Aquitanian',  \n            round(MIN_AGE) %in% c(16:20) ~ 'Burdigalian',\n            round(MIN_AGE) %in% c(14:15) ~ 'Langhian',\n            round(MIN_AGE) %in% c(12:13) ~ 'Serravallian',\n            round(MIN_AGE) %in% c(11:8) ~ 'Tortonian',\n            round(MIN_AGE) %in% c(5:7) ~ 'Messinian',\n            round(MIN_AGE) %in% c(4:5) ~ 'Zanclean',\n            round(MIN_AGE) %in% c(2:3) ~ 'Piacenzian')     \n  \n  \n}\n\nchange_period_to_midpoint <- function(period) {\n  case_when(\n    period == 'Aquitanian'  ~ mean(c(21, 23)),\n    period == 'Burdigalian' ~ mean(c(16, 20)),\n    period == 'Langhian'    ~ mean(c(14, 15)),\n    period == 'Serravallian' ~ mean(c(12, 13)),\n    period == 'Tortonian'   ~ mean(c(8, 11)),\n    period == 'Messinian'   ~ mean(c(5, 7)),\n    period == 'Zanclean'    ~ mean(c(4, 5)),\n    period == 'Piacenzian'  ~ mean(c(2, 3)),\n    TRUE ~ NA_real_  # Return NA if no match\n  )\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n## apply the function\n\nfossil <- \n  fossil |> \n  mutate(\n    time_period_max = change_time_to_period(MAX_AGE), \n    time_period_min = change_time_to_period(MIN_AGE),\n    midpoint_time = rowMeans(data.frame(MAX_AGE, MIN_AGE), na.rm = T), \n    midpoint_period = change_time_to_period(midpoint_time)\n  )\n```\n:::\n\n\nSecond, let's bring region level grid-data and match it the spatial coordinates of our dataset. This will be our region of interest `ROI`\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n## Load grided data on regions of north america and europe\nreg_gridded <- st_read(\"DATA/regions_gridded/Data_RegionsGridded.shp\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `Data_RegionsGridded' from data source \n  `C:\\Users\\gabri\\Documents\\PhD\\00_Chapter_fossil\\02_chapter_fossil\\manuscript\\quarto_manuscript\\fossil_deeptime\\notebooks\\DATA\\regions_gridded\\Data_RegionsGridded.shp' \n  using driver `ESRI Shapefile'\nSimple feature collection with 1635 features and 9 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: -125 ymin: 26 xmax: 51 ymax: 56\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nplot(reg_gridded$geometry, col = as.factor(reg_gridded$Region))\n```\n\n::: {.cell-output-display}\n![](00_data_import_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\nLet's now make a geographical linkage between the two datasets, but first correct the coordinates of the fossil dataset with tecnonic plate movement. Using the method of Merdith et al., 2021\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nfossil <- palaeorotate(occdf = fossil, age = \"midpoint_time\", lat = \"LAT\", lng = \"LONG\", method = 'grid')\nfossil_dat <- st_as_sf(fossil, coords = c('rot_lng', 'rot_lat'), remove = F, crs = 4326)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nfossil_dat <- readRDS(\"DATA/out/fossil_data_cleaned_geo_corrected.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# convert fosil data to a geographic object\n\n\n# apply spatial filter to add region info to fossil data\n\nsubset_fossil <- fossil_dat[lengths(st_intersects(fossil_dat,reg_gridded)) > 0,] \n\n## add spatial info to the fossil dataset \n\nsubset_fossil$region <- reg_gridded$Region[st_intersects(fossil_dat,reg_gridded) |> unlist()]\n\nsubset_fossil$WorldMapID <- reg_gridded$WorldMapID[st_intersects(fossil_dat,reg_gridded) |> unlist()]\n```\n:::\n\n\nLet's visualize geographical sampling completeness for all time-periods\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n## Observe the result \n\nplot(reg_gridded$geometry, \n     col = scales::alpha(as.numeric(as.factor(reg_gridded$Region)), 0.2), \n     border = 0 )\nsubset_fossil$geometry |> plot(add = T, pch = 6, cex = 0.2, col = 'black')\nsubset_fossil$geometry |> plot(add = T, pch = 2, cex = 0.2, col = 'black')\n```\n\n::: {.cell-output-display}\n![](00_data_import_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n\nLet's visualize geographical sampling completeness for each time period\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nsubset_fossil |>\n  group_by(rot_age) |> \n  summarize(nloc = n_distinct(geometry)) |> \n  ggplot() + \n  geom_sf(data  = reg_gridded,\n          aes(fill = Region), alpha = 0.3, size = 0.3, color = NA) + \n  facet_wrap(~rot_age, ncol = 2) + \n  theme_minimal()  + \n  geom_sf( shape = 24, fill = 'black', size = 0.2,  col = 'black') + \n  geom_sf( shape = 6, fill = 'black', col = 'black', size = 0.2) +\n   theme(legend.position = \"bottom\", legend.direction = \"horizontal\", \n             legend.key.size = unit(0.2, \"cm\"),  # Adjust the size of the legend keys\n    legend.text = element_text(size = 6) ) # Adjust the text size in the legend)\n```\n\n::: {.cell-output-display}\n![](00_data_import_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\nIt looks evenly spread! Let's keep the `rot_age:rotated age`` as our reference variable for the temporal axis. Let's redefine the periods based on this axis. \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nsubset_fossil <- \nsubset_fossil |> \n  mutate(midpoint_period = change_time_to_period(rot_age), \n         hex_id = paste(rot_lng, rot_lat))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nsubset_fossil |>\n  group_by(midpoint_period) |> \n  summarize(nloc = n_distinct(geometry)) |> \n  ggplot() +\n geom_sf(data  = reg_gridded,\n          aes(fill = Region), alpha = 0.3, size = 0.3, color = NA) + \n  facet_wrap(~midpoint_period, ncol = 2) + \n  theme_minimal()  + \n  geom_sf( shape = 24, fill = 'black', size = 0.2,  col = 'black') + \n  geom_sf( shape = 6, fill = 'black', col = 'black', size = 0.2) +\n   theme(legend.position = \"bottom\", legend.direction = \"horizontal\", \n             legend.key.size = unit(0.2, \"cm\"),  # Adjust the size of the legend keys\n    legend.text = element_text(size = 6) ) # Adjust the text size in the legend)\n```\n\n::: {.cell-output-display}\n![](00_data_import_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n\nAggregating hex bins to gridded paleocommunities \n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nxydat <- subset_fossil %>% \ndistinct(geometry)\nxydat <- st_as_sf(xydat, \n                  coords = c('rot_lng', 'rot_lat'), \n                  crs = 4326)\n\ngrid_5 <- st_make_grid(xydat, cellsize = 5) |> st_sf()\n```\n:::\n\n\nLet’s define a function that matches the focal grids with the fossil sampling locations\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nassign_grid_id <- function(xydat, grid){\n\n\nmy_list <- st_intersects(xydat, grid)\nmy_list[lengths(my_list) == 0] <- NA\n\nreturn(unlist(my_list, use.names = FALSE))\n\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nsubset_fossil <- \nsubset_fossil |> \n  mutate(grid_id_5  = assign_grid_id(geometry, grid_5))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n## summarize sampling intensity and richness\n\nsubset_fossil_summary <- \nsubset_fossil |>\n  group_by(midpoint_period, grid_id_5) |> \n  summarize(sampling_intensity = n_distinct(LIDNUM), \n            genus_richness = n_distinct(GENUS)) |> \n  arrange(sampling_intensity) \n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n`summarise()` has grouped output by 'midpoint_period'. You can override using\nthe `.groups` argument.\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nsubset_fossil_summary |>\n  ggplot() + \n  geom_point(aes(x = sampling_intensity, \n                 y = genus_richness, \n                 color = midpoint_period)) + \n  geom_smooth(aes(x = sampling_intensity, \n                 y = genus_richness)) + \n  theme_minimal() + \n  xlab('Sampling effort') + \n  ylab('Richness of Genera')\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](00_data_import_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nsubset_fossil_summary |>\n  ggplot() + \n  geom_point(aes(x = sampling_intensity, \n                 y = genus_richness)) + \n  facet_wrap(~midpoint_period) + \n  geom_smooth(aes(x = sampling_intensity, \n                 y = genus_richness)) + \n  theme_minimal() + \n  xlab('Sampling effort') + \n  ylab('Richness of Genera')\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning in simpleLoess(y, x, w, span, degree = degree, parametric = parametric,\n: pseudoinverse used at 0.91\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning in simpleLoess(y, x, w, span, degree = degree, parametric = parametric,\n: neighborhood radius 3.09\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning in simpleLoess(y, x, w, span, degree = degree, parametric = parametric,\n: reciprocal condition number 1.0849e-16\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning in simpleLoess(y, x, w, span, degree = degree, parametric = parametric,\n: There are other near singularities as well. 9\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning in predLoess(object$y, object$x, newx = if (is.null(newdata)) object$x\nelse if (is.data.frame(newdata))\nas.matrix(model.frame(delete.response(terms(object)), : pseudoinverse used at\n0.91\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning in predLoess(object$y, object$x, newx = if (is.null(newdata)) object$x\nelse if (is.data.frame(newdata))\nas.matrix(model.frame(delete.response(terms(object)), : neighborhood radius\n3.09\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning in predLoess(object$y, object$x, newx = if (is.null(newdata)) object$x\nelse if (is.data.frame(newdata))\nas.matrix(model.frame(delete.response(terms(object)), : reciprocal condition\nnumber 1.0849e-16\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning in predLoess(object$y, object$x, newx = if (is.null(newdata)) object$x\nelse if (is.data.frame(newdata))\nas.matrix(model.frame(delete.response(terms(object)), : There are other near\nsingularities as well. 9\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](00_data_import_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nsubset_fossil_summary  |>\n  ggplot() +\n geom_sf(data  = reg_gridded,\n          aes(fill = Region), alpha = 0.3, size = 0.3, color = NA) + \n  facet_wrap(~midpoint_period, ncol = 2) + \n  theme_minimal()  + \n  geom_sf( shape = 24,  size = sqrt(subset_fossil_summary$sampling_intensity)/5,  col = 'black') + \n   theme(legend.position = \"bottom\", legend.direction = \"horizontal\", \n             legend.key.size = unit(0.2, \"cm\"),  # Adjust the size of the legend keys\n    legend.text = element_text(size = 6) ) # Adjust the text size in the legend)\n```\n\n::: {.cell-output-display}\n![](00_data_import_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\n\n\n## Taxonomic coverage per time period\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nlibrary(ggraph)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: package 'ggraph' was built under R version 4.3.2\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(tidygraph)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: package 'tidygraph' was built under R version 4.3.2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'tidygraph'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following object is masked from 'package:stats':\n\n    filter\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n## define a function to plot a dendrogram \nmake_dendro <- function(subset_fossil){\n  graph_s <- rbind(\n    subset_fossil %>% \n      select(ORDER) %>% \n      mutate(lucy = 1)%>% unique %>% \n      rename('from' = lucy, 'to' = ORDER) , \n    subset_fossil %>% \n      select(ORDER, FAMILY) %>% unique %>% \n      rename('from' = ORDER, 'to' = FAMILY), \n    subset_fossil %>% unique %>% \n      select(FAMILY, GENUS) %>% \n      rename('from' = FAMILY, 'to' = GENUS ))\n  \n  \n  \n  graph_s <- \n    graph_s |> \n    select(from, to) |> \n    as_tbl_graph(directed = TRUE)\n  \n  ggraph(graph_s, 'dendrogram', circular = TRUE)  + \n    geom_edge_diagonal() + \n    geom_node_text(aes(label = ifelse(name %in% subset_fossil$GENUS, \"\", name))) +  \n    theme_void()\n  \n  \n  \n}\n```\n:::\n\n\n::: panel-tabset\n#### Aquitanian\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nmake_dendro(subset_fossil[subset_fossil$midpoint_period == 'Aquitanian', ])\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nMultiple parents. Unfolding graph\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: Using the `size` aesthetic in this geom was deprecated in ggplot2 3.4.0.\nℹ Please use `linewidth` in the `default_aes` field and elsewhere instead.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](00_data_import_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n\n\n#### Burdigalian\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nmake_dendro(subset_fossil[subset_fossil$midpoint_period == 'Burdigalian', ])\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nMultiple parents. Unfolding graph\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](00_data_import_files/figure-html/unnamed-chunk-23-1.png){width=672}\n:::\n:::\n\n\n#### Langhian\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nmake_dendro(subset_fossil[subset_fossil$midpoint_period == 'Langhian', ])\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nMultiple parents. Unfolding graph\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](00_data_import_files/figure-html/unnamed-chunk-24-1.png){width=672}\n:::\n:::\n\n\n#### Serravallian\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nmake_dendro(subset_fossil[subset_fossil$midpoint_period == 'Serravallian', ])\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nMultiple parents. Unfolding graph\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](00_data_import_files/figure-html/unnamed-chunk-25-1.png){width=672}\n:::\n:::\n\n\n#### Tortonian\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nmake_dendro(subset_fossil[subset_fossil$midpoint_period == 'Tortonian', ])\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nMultiple parents. Unfolding graph\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](00_data_import_files/figure-html/unnamed-chunk-26-1.png){width=672}\n:::\n:::\n\n\n#### Messinian\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nmake_dendro(subset_fossil[subset_fossil$midpoint_period == 'Messinian', ])\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nMultiple parents. Unfolding graph\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](00_data_import_files/figure-html/unnamed-chunk-27-1.png){width=672}\n:::\n:::\n\n\n#### Zanclean\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nmake_dendro(subset_fossil[subset_fossil$midpoint_period == 'Zanclean', ])\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nMultiple parents. Unfolding graph\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](00_data_import_files/figure-html/unnamed-chunk-28-1.png){width=672}\n:::\n:::\n\n\n#### Piacenzian\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nmake_dendro(subset_fossil[subset_fossil$midpoint_period == 'Piacenzian', ])\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nMultiple parents. Unfolding graph\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](00_data_import_files/figure-html/unnamed-chunk-29-1.png){width=672}\n:::\n:::\n\n:::\n\nSeems like a balanced distribution of GENUS across time periods, with no extreme changes in the information available.\n\nWe can also spot the presence of `indet.` & `incertae sedis` data in the dataset. Those records may correspond to unidentified species or something else. But we will find and remove them from the dataset at the GENUS LEVEL.\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nlibrary(stringr)\n\nto_rem <- \nwhich(\nstr_detect(subset_fossil$GENUS, 'indet|incertae') | str_detect(subset_fossil$FAMILY, 'indet|incertae') | str_detect(subset_fossil$SPECIES, 'indet|incertae')\n) \n\n\n\n# remove indetermined genus \n\nsubset_fossil <- subset_fossil[-to_rem,]\n```\n:::\n\n\nAfter this cleaning steps, lets count the number of species per grid and remain only with the grids-periods of time pairs with at least `5` species each.\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nsubset_fossil <- subset_fossil |> mutate(sp_id = paste0(GENUS,\"_\", SPECIES))\n\n\nsubset_fossil$gr_id <- as.numeric(is.numeric(subset_fossil$grid_id_5))\n\n# \ngrid_wt_enough_data <- \nsubset_fossil |> \ngroup_by(region, midpoint_period ) |> \nsummarize(n_sp  = n_distinct(sp_id), \nn_gen = n_distinct(GENUS))  |> \nfilter(n_sp > 5)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n`summarise()` has grouped output by 'region'. You can override using the\n`.groups` argument.\n```\n\n\n:::\n:::\n\n\nlet's now filter the fossil dataset based on those grid ids\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nsubset_fossil <- \nsubset_fossil |> \nfilter(paste(region, midpoint_period) %in% \npaste(grid_wt_enough_data$region, grid_wt_enough_data$midpoint_period))\n```\n:::\n\n\nFinally, let's count the dimensions of our dataset\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nsubset_fossil |> dim()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 11066    26\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nsaveRDS(subset_fossil, 'DATA/out/fossil_data_cleaned.rds')\n```\n:::\n\n::: {.cell fig-caption='Number of observations per region and time period. Note that the cell numbers have been sqrt transformed for a better visualization of the gradient.'}\n\n```{.r .cell-code .hidden}\n#| fig-caption: Number of observations per region and time period. Note that the cell numbers have been sqrt transformed for a better visualization of the gradient.\n#|\n\n## number of records per region and time  \nxtabs(gr_id ~ region + midpoint_period, subset_fossil) |> sqrt() |> heatmap()\n```\n\n::: {.cell-output-display}\n![](00_data_import_files/figure-html/unnamed-chunk-35-1.png){width=672}\n:::\n:::\n\n\nWe can observe that regions are relatively equally sample in space, but not in time. Particularly, the periods `Aquitanian`, `Zanclean`, `Serravallian` and `Piacenzian` seem to be relatively less well sampled\n\n\n::: {.cell fig-caption='Number of species counts per region and time period. Note that the cell numbers have been sqrt transformed for a better visualization of the gradient.'}\n\n```{.r .cell-code .hidden}\n#| fig-caption: Number of species counts per region and time period. Note that the cell numbers have been sqrt transformed for a better visualization of the gradient.\n# number of species per region and time  \nxtabs(ifelse(is.na(subset_fossil$sp_id),0,1) ~ region + midpoint_period, subset_fossil) |> sqrt() |> heatmap()\n```\n\n::: {.cell-output-display}\n![](00_data_import_files/figure-html/unnamed-chunk-36-1.png){width=672}\n:::\n:::\n\n\nWe observe that the species richness patterns follows the sampling effort pattern. We should address this covariance in our modelling approaches.\n",
    "supporting": [
      "00_data_import_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}